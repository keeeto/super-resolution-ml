

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Tutorials &mdash; sciml-image 0.0 documentation</title>
  

  
  <link rel="stylesheet" href="_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="_static/pygments.css" type="text/css" />

  
  
  
  

  
  <!--[if lt IE 9]>
    <script src="_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="./" src="_static/documentation_options.js"></script>
        <script src="_static/jquery.js"></script>
        <script src="_static/underscore.js"></script>
        <script src="_static/doctools.js"></script>
        <script src="_static/language_data.js"></script>
    
    <script type="text/javascript" src="_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Loss functions" href="loss_functions.html" />
    <link rel="prev" title="Models available" href="models.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="index.html" class="icon icon-home" alt="Documentation Home"> sciml-image
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Documentation:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="models.html">Models available</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Tutorials</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#segmentation-of-x-ray-images">Segmentation of X-ray images</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#step-1">Step 1</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-2">Step 2</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-3">Step 3</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-4">Step 4</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-5">Step 5</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-6">Step 6</a></li>
<li class="toctree-l3"><a class="reference internal" href="#step-7">Step 7</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="loss_functions.html">Loss functions</a></li>
<li class="toctree-l1"><a class="reference internal" href="modules.html">Python API</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="index.html">sciml-image</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Tutorials</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
            
            <a href="_sources/tutorials.rst.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="tutorials">
<h1>Tutorials<a class="headerlink" href="#tutorials" title="Permalink to this headline">¶</a></h1>
<div class="section" id="segmentation-of-x-ray-images">
<h2>Segmentation of X-ray images<a class="headerlink" href="#segmentation-of-x-ray-images" title="Permalink to this headline">¶</a></h2>
<p>This tutorial looks at building a segmentation model to classify regions in an X-ray image of an
additive layer manufacturing process. In the process a laser beam is shone across a material
surface and debris spatters up from the material. We want to build a model that can identify
the regions of debris spattered up from the surface.</p>
<a class="reference internal image-reference" href="_images/x-ray-image.png"><img alt="alternate text" class="align-center" src="_images/x-ray-image.png" style="width: 640.0px; height: 256.0px;" /></a>
<p>To do this we will use a U-net architecture. There are some challenges in using most U-net
architectures that you will find on the web.</p>
<blockquote>
<div><p>(i) The image sizes are very large. This means that the image and the model cannot fit
together in the memory.</p>
<p>(ii) The classes are very imbalanced. There is 98% nothing to see in the images, so the
model finds it very easy to classify everything as background and feel satisfied.</p>
</div></blockquote>
<p>To overcome the first problem we will use a routine in <cite>sciml-image</cite> to create patches from
the image and learn sequentially from each patch. To do do this we have implemented the
<cite>image_models.data_handeling.generators.mask_patch_from_file</cite> function which acts as a
generator to feed the network for training.</p>
<p>To overcome the issue of class imbalance we will use a special loss function called
<a class="reference internal" href="image_models.models.losses.html#image_models.models.losses.custom_loss_functions.weighted_cross_entropy" title="image_models.models.losses.custom_loss_functions.weighted_cross_entropy"><code class="xref py py-meth docutils literal notranslate"><span class="pre">image_models.models.losses.custom_loss_functions.weighted_cross_entropy()</span></code></a>.
Regular crossentropy on a binary segmentation peanilises equally
for false positives and false negatives. However, in our case false positives will be
very rare and false negatives much more common, due to 98% of the image being ‘positive’.
<cite>weighted_cross_entropy</cite> applies a factor to the loss function to increase or decrease the
penalty for false positives. If this factor is greater than 1 then it adds greater weight
to a loss for a false positive, if it is less than 1 it reduces this weight.</p>
<div class="section" id="step-1">
<h3>Step 1<a class="headerlink" href="#step-1" title="Permalink to this headline">¶</a></h3>
<p>The first step is to set up the training data in the correct formats and directories.
We will take an original large image and mask, and convert them into smaller windows
of the originals, in the appropriate directories for the later training. We use the
<cite>image_models.utils.alm.tools.image_to_windows</cite> function in to do this.
The original image and mask files should be on their own in individual directories.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">sciml</span><span class="o">-</span><span class="n">image</span>
<span class="kn">from</span> <span class="nn">utils.alm.tools</span> <span class="kn">import</span> <span class="n">image_to_windows</span>

<span class="c1">## Convert the training images to windows</span>
<span class="n">patch_origin</span> <span class="o">=</span> <span class="o">&lt;</span><span class="nb">tuple</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span><span class="o">&gt;</span>
<span class="n">patch_size</span> <span class="o">=</span> <span class="o">&lt;</span><span class="nb">tuple</span> <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span><span class="o">&gt;</span>
<span class="n">ftypes</span> <span class="o">=</span> <span class="o">&lt;</span><span class="nb">list</span> <span class="n">eg</span> <span class="p">[</span><span class="s1">&#39;.tif&#39;</span><span class="p">]</span><span class="o">&gt;</span>
<span class="n">num_patches</span> <span class="o">=</span> <span class="o">&lt;</span><span class="nb">int</span> <span class="o">&gt;</span>

<span class="c1">### First the image</span>
<span class="n">datapath</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">the</span> <span class="n">directory</span> <span class="n">where</span> <span class="n">the</span> <span class="n">image</span> <span class="n">file</span> <span class="ow">is</span><span class="o">&gt;</span>
<span class="n">savepath</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">the</span> <span class="n">directory</span> <span class="n">to</span> <span class="n">save</span> <span class="n">the</span> <span class="n">patches</span> <span class="n">to</span><span class="o">&gt;</span>
<span class="n">prefix</span><span class="o">=</span> <span class="o">&lt;</span><span class="n">prefix</span> <span class="n">to</span> <span class="n">give</span> <span class="n">the</span> <span class="n">patch</span> <span class="n">files</span><span class="o">&gt;</span>
<span class="n">image_to_windows</span><span class="p">(</span><span class="n">datapath</span><span class="p">,</span> <span class="n">ftypes</span><span class="p">,</span> <span class="n">patch_size</span><span class="o">=</span><span class="n">patch_size</span><span class="p">,</span> <span class="n">patch_origin</span><span class="o">=</span><span class="n">patch_origin</span><span class="p">,</span>
              <span class="n">savepath</span><span class="o">=</span><span class="n">savepath</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span> <span class="n">num_patches</span><span class="o">=</span><span class="n">num_patches</span><span class="p">)</span>

<span class="c1">### Next the mask</span>
<span class="n">datapath</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">the</span> <span class="n">directory</span> <span class="n">where</span> <span class="n">the</span> <span class="n">mask</span> <span class="n">file</span> <span class="ow">is</span><span class="o">&gt;</span>
<span class="n">savepath</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">the</span> <span class="n">directory</span> <span class="n">to</span> <span class="n">save</span> <span class="n">the</span> <span class="n">patches</span> <span class="n">to</span><span class="o">&gt;</span>
<span class="n">prefix</span><span class="o">=</span> <span class="o">&lt;</span><span class="n">prefix</span> <span class="n">to</span> <span class="n">give</span> <span class="n">the</span> <span class="n">patch</span> <span class="n">files</span><span class="o">&gt;</span>
<span class="n">image_to_windows</span><span class="p">(</span><span class="n">datapath</span><span class="p">,</span> <span class="n">ftypes</span><span class="p">,</span> <span class="n">patch_size</span><span class="o">=</span><span class="n">patch_size</span><span class="p">,</span> <span class="n">patch_origin</span><span class="o">=</span><span class="n">patch_origin</span><span class="p">,</span>
                 <span class="n">savepath</span><span class="o">=</span><span class="n">savepath</span><span class="p">,</span> <span class="n">prefix</span><span class="o">=</span><span class="n">prefix</span><span class="p">,</span> <span class="n">num_patches</span><span class="o">=</span><span class="n">num_patches</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="step-2">
<h3>Step 2<a class="headerlink" href="#step-2" title="Permalink to this headline">¶</a></h3>
<p>Once the data is in place we are ready to start setting up the U-net.
Tell the code where to find the images and masks, the types of file to
expect.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">datapath</span><span class="o">=&lt;</span><span class="n">the</span> <span class="n">root</span> <span class="n">directory</span> <span class="n">of</span> <span class="n">images</span> <span class="ow">and</span> <span class="n">masks</span><span class="o">&gt;</span>
<span class="n">img_dir</span><span class="o">=&lt;</span><span class="n">the</span> <span class="n">subdirectory</span> <span class="n">where</span> <span class="n">images</span> <span class="n">are</span><span class="o">&gt;</span>
<span class="n">mask_dir</span><span class="o">=&lt;</span><span class="n">the</span> <span class="n">subdirectory</span> <span class="n">where</span> <span class="n">masks</span> <span class="n">are</span><span class="o">&gt;</span>
<span class="n">ftypes</span><span class="o">=</span><span class="p">(</span><span class="o">&lt;</span><span class="n">filetypes</span> <span class="n">to</span> <span class="n">look</span> <span class="k">for</span><span class="o">&gt;</span><span class="p">)</span> <span class="c1"># e.g. (&#39;.tif&#39;)</span>
</pre></div>
</div>
</div>
<div class="section" id="step-3">
<h3>Step 3<a class="headerlink" href="#step-3" title="Permalink to this headline">¶</a></h3>
<p>Set up the information about the size of the original image and the size of the
patches to take from the image. Also here you can define a list of which patches
to use. This last feature is useful when the interesting features are only in a
section of the image. You can specify the particular patches to consider for the
training. The numbering of patches starts from zero and proceeds left to right
top to bottom. If the patch list is left empty the generator uses all patches.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">image_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">1280</span><span class="p">)</span>
<span class="n">patch_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>
<span class="n">patch_range</span> <span class="o">=</span> <span class="p">[</span><span class="mi">31</span><span class="p">,</span> <span class="mi">32</span><span class="p">,</span> <span class="mi">33</span><span class="p">,</span> <span class="mi">34</span><span class="p">,</span> <span class="mi">39</span><span class="p">,</span> <span class="mi">62</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="section" id="step-4">
<h3>Step 4<a class="headerlink" href="#step-4" title="Permalink to this headline">¶</a></h3>
<p>Set up the generator. This is the function that will flow the patches from the images
to the netowrk for training.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">data_handeling.generators</span> <span class="kn">import</span> <span class="n">mask_patch_from_file</span>

<span class="n">myGene</span> <span class="o">=</span> <span class="n">mask_patch_from_file</span><span class="p">(</span><span class="n">datapath</span><span class="p">,</span>
                           <span class="n">img_dir</span><span class="p">,</span> <span class="n">mask_dir</span><span class="p">,</span>
                           <span class="n">patch_shape</span><span class="p">,</span> <span class="n">image_shape</span><span class="p">,</span>
                           <span class="n">types</span> <span class="o">=</span> <span class="n">ftypes</span><span class="p">,</span> <span class="n">patch_range</span><span class="o">=</span><span class="n">patch_range</span><span class="p">,</span>
                           <span class="n">debug</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                           <span class="n">batch_size</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
                           <span class="n">normalise_images</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="step-5">
<h3>Step 5<a class="headerlink" href="#step-5" title="Permalink to this headline">¶</a></h3>
<p>Define the netowrk architecture, the hyperparameters and the training time.
Here the input size is the dimension of the patches, also we have just 1
channel as the image is greyscale. We use a standard SGD optimiser. The
<cite>weighted_cross_entropy</cite> loss function is set up with a factor of 7 to help
counter the class imbalance.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">models.u_net.model</span> <span class="kn">import</span> <span class="n">unet</span>
<span class="kn">import</span> <span class="nn">models.losses.custom_loss_functions</span> <span class="k">as</span> <span class="nn">losses</span>

<span class="n">model</span> <span class="o">=</span> <span class="n">unet</span><span class="p">(</span><span class="n">input_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">patch_shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">patch_shape</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="mi">1</span><span class="p">))</span>
<span class="n">opt</span> <span class="o">=</span> <span class="n">SGD</span><span class="p">(</span><span class="n">lr</span><span class="o">=</span><span class="mf">1e-3</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">decay</span><span class="o">=</span><span class="mf">1e-4</span> <span class="o">/</span> <span class="n">epochs</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">loss</span><span class="o">=</span><span class="n">losses</span><span class="o">.</span><span class="n">weighted_cross_entropy</span><span class="p">(</span><span class="mi">7</span><span class="p">),</span> <span class="n">optimizer</span><span class="o">=</span><span class="n">opt</span><span class="p">,</span>
           <span class="n">metrics</span><span class="o">=</span><span class="p">[</span><span class="s2">&quot;accuracy&quot;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="section" id="step-6">
<h3>Step 6<a class="headerlink" href="#step-6" title="Permalink to this headline">¶</a></h3>
<p>Train and save!</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">epochs</span> <span class="o">=</span> <span class="mi">5</span>
<span class="n">steps_per_epoch</span> <span class="o">=</span> <span class="mi">800</span>
<span class="n">model</span><span class="o">.</span><span class="n">fit_generator</span><span class="p">(</span><span class="n">myGene</span><span class="p">,</span> <span class="n">steps_per_epoch</span><span class="o">=</span><span class="n">steps_per_epoch</span><span class="p">,</span> <span class="n">epochs</span><span class="o">=</span><span class="n">epochs</span><span class="p">)</span>
<span class="n">model</span><span class="o">.</span><span class="n">save_weights</span><span class="p">(</span><span class="s1">&#39;saved_weights.hdf5&#39;</span><span class="p">)</span>
<span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s1">&#39;model.yaml&#39;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">yaml_file</span><span class="p">:</span>
    <span class="n">yaml_file</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">model_yaml</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="step-7">
<h3>Step 7<a class="headerlink" href="#step-7" title="Permalink to this headline">¶</a></h3>
<p>Run the model for inference. Having trained the model on some images you can now try to deploy on
new examples. We have the <a class="reference internal" href="image_models.utils.html#image_models.utils.tools.inference_binary_segmentation" title="image_models.utils.tools.inference_binary_segmentation"><code class="xref py py-meth docutils literal notranslate"><span class="pre">image_models.utils.tools.inference_binary_segmentation()</span></code></a> helper
function to do this. First we load up the saved model and weights.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">image_models.utils.tools</span> <span class="kn">import</span> <span class="n">inference_binary_segmentation</span>
<span class="kn">from</span> <span class="nn">keras.models</span> <span class="kn">import</span> <span class="n">model_from_yaml</span>

<span class="n">datapath</span> <span class="o">=</span> <span class="s1">&#39;./test_images/&#39;</span>
<span class="n">patch_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">64</span><span class="p">)</span>
<span class="n">image_shape</span> <span class="o">=</span> <span class="p">(</span><span class="mi">512</span><span class="p">,</span> <span class="mi">1280</span><span class="p">)</span>
<span class="n">model_file</span> <span class="o">=</span> <span class="s1">&#39;model.yaml&#39;</span>
<span class="n">weights_file</span> <span class="o">=</span> <span class="s1">&#39;saved_weights-1.hdf5&#39;</span>
<span class="n">savepath</span> <span class="o">=</span> <span class="s1">&#39;./inferred_masks/&#39;</span>

<span class="c1"># load YAML and create model</span>
<span class="n">yaml_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">model_file</span><span class="p">,</span> <span class="s1">&#39;r&#39;</span><span class="p">)</span>
<span class="n">loaded_model_yaml</span> <span class="o">=</span> <span class="n">yaml_file</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>
<span class="n">yaml_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
<span class="n">loaded_model</span> <span class="o">=</span> <span class="n">model_from_yaml</span><span class="p">(</span><span class="n">loaded_model_yaml</span><span class="p">)</span>
<span class="c1"># load weights into new model</span>
<span class="n">loaded_model</span><span class="o">.</span><span class="n">load_weights</span><span class="p">(</span><span class="n">weights_file</span><span class="p">)</span>

<span class="n">inference_binary_segmentation</span><span class="p">(</span><span class="n">datapath</span><span class="p">,</span> <span class="n">patch_shape</span><span class="p">,</span> <span class="n">image_shape</span><span class="p">,</span> <span class="n">loaded_model</span><span class="p">,</span>
                 <span class="n">file_prefix</span><span class="o">=</span><span class="s1">&#39;binary_mask&#39;</span><span class="p">,</span> <span class="n">savepath</span><span class="o">=</span><span class="n">savepath</span><span class="p">,</span> <span class="n">fig_size</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span> <span class="mi">8</span><span class="p">))</span>
</pre></div>
</div>
<p>In the <cite>inferred_masks</cite> directory there should now be a masking file something like:</p>
<img alt="_images/x-ray-mask.png" src="_images/x-ray-mask.png" />
</div>
</div>
</div>


           </div>
           
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="loss_functions.html" class="btn btn-neutral float-right" title="Loss functions" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="models.html" class="btn btn-neutral float-left" title="Models available" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
        
        &copy; Copyright 2019, Keith T. Butler

    </p>
  </div>
    
    
    
    Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>